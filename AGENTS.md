# AGENTS.md

## Repository Purpose
VibiNet is a deterministic input-synced netcode library for realtime multiplayer games.
Clients replay the same input stream and compute the same game state.
The official public server endpoint is `wss://net.studiovibi.com`.

## High-Level Architecture
- `src/vibi.ts` is the replay engine.
- `src/client.ts` is the WebSocket transport/time sync client.
- `src/server.ts` is the official Bun server (HTTP + WebSocket).
- `src/packer.ts` + `src/protocol.ts` define compact binary wire format.
- `walkers/` is the browser demo/tutorial app.
- `scripts/` contains deployment and server sync automation.

## Official Server And Operations Context
- Official host: `net.studiovibi.com`.
- SSH alias expected on maintainer machines: `vibibr`.
- Current production machine: `ubuntu@18.230.148.202`.
- Remote runbook (primary ops document): `/home/ubuntu/VIBINET_SERVER_NOTES.md`.
- Remote app repo path: `/home/ubuntu/vibinet`.
- Remote auto-sync tracks only GitHub branch `main`.

## File Map (Versioned Files)
| Path | What it is |
| --- | --- |
| `.gitignore` | Ignore rules for deps, builds, local DB/runtime artifacts. |
| `README.md` | Main documentation, Quick Start, API concepts, self-hosting notes. |
| `bun.lock` | Bun lockfile for deterministic dependency resolution. |
| `package.json` | Package metadata, exports, scripts, dependencies, prepack checks. |
| `tsconfig.json` | TypeScript compiler configuration. |
| `scripts/check-official-endpoint.sh` | Guardrail that rejects deprecated official `ws://...:8080` references. |
| `scripts/deploy.sh` | Manual deploy fallback; rsync + remote restart path. |
| `scripts/setup-auto-sync.sh` | Installs/updates remote systemd sync units. |
| `scripts/sync-main.sh` | Canonical server sync script: fetch/reset/install/restart. |
| `src/binary.ts` | Low-level binary read/write helpers for storage and protocol internals. |
| `src/client.ts` | Browser/client WebSocket API with time sync and room watch/load/post ops. |
| `src/index.ts` | Public module entry exports. |
| `src/packer.ts` | Schema-based bit-level serializer/deserializer used by VibiNet protocol/payloads. |
| `src/protocol.ts` | Wire message schema and encode/decode adapters. |
| `src/server.ts` | Bun HTTP+WS server, post broadcast/storage, walkers static serving/build. |
| `src/server_url.ts` | Official endpoint constant + URL normalization helpers. |
| `src/storage.ts` | Append-only room persistence (`db/*.dat` and `db/*.idx`). |
| `src/vibi.ts` | Deterministic replay engine (ticks, rollback, smoothing, snapshots). |
| `test/packer.test.ts` | Unit tests for serializer correctness and sizes. |
| `test/sim_network.ts` | Deterministic simulated network utilities used by integration tests. |
| `test/vibi_sim.test.ts` | End-to-end deterministic sync tests under latency/jitter/loss-like scenarios. |
| `test/walkers_game.ts` | Shared walkers game logic/packer fixtures for tests. |
| `walkers/README.md` | Walkers demo-specific instructions. |
| `walkers/index.html` | Walkers HTML shell (canvas + module script load). |
| `walkers/index.ts` | Walkers demo game logic + browser bootstrap. |

## Generated/Runtime Files (Not Versioned)
| Path pattern | What it is |
| --- | --- |
| `dist/index.js` | Library bundle generated by `npm run build`/`prepack`. |
| `walkers/dist/*` | Browser bundles generated by server startup/build. |
| `db/*.dat`, `db/*.idx` | Persistent room event storage files. |
| `.tmp/*` | Local scratch files and temporary logs. |

## Agent Working Rules For This Repo
1. Keep `AGENTS.md` updated whenever files are added, removed, renamed, or responsibilities change.
2. Do not hardcode `ws://net.studiovibi.com:8080`; official default is `wss://net.studiovibi.com`.
3. Before publishing/deploying, run `npm run check:official-endpoint`, `npm run check`, and `bun test`.
4. For production server updates, treat GitHub `main` as source of truth; remote auto-sync mirrors `main`.
5. Do not manually edit production code on the remote host; changes must come from commits to this repo.
6. If server behavior changes, update both this file and `/home/ubuntu/VIBINET_SERVER_NOTES.md`.
